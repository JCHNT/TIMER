<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Timer Examen Universitaire</title>
    <style>
        body {
            font-family: sans-serif;
            text-align: center;
            background-color: #F2F2F2;
            margin: 0;
            padding: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .dashboard-container {
            background-color: #FFFFFF;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0px 10px 30px rgba(0, 0, 0, 0.1);
            width: 800px;
            max-width: 90%;
        }
        .timer-global {
            font-size: 4em;
            color: #2C3E50;
            margin-bottom: 20px;
            font-weight: bold;
        }
        .exam-info {
            font-size: 1.5em;
            color: #34495E;
            margin-bottom: 10px;
        }
        .student-info {
            font-size: 1.2em;
            color: #7F8C8D;
            margin-bottom: 30px;
            border-bottom: 1px solid #ECF0F1;
            padding-bottom: 20px;
        }
        .question-section {
            margin-top: 30px;
            margin-bottom: 30px;
        }
        .question-number {
            font-size: 1.8em;
            color: #2C3E50;
            margin-bottom: 10px;
            font-weight: bold;
        }
        .timer-question {
            font-size: 1.5em;
            color: #E67E22;
            margin-bottom: 20px;
            font-weight: bold;
        }
        .progress-bar-container {
            width: 100%;
            background-color: #ECF0F1;
            border-radius: 5px;
            height: 10px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            width: 0%;
            background-color: #3498DB;
            border-radius: 5px;
            transition: width 0.3s ease;
        }
        .button-next {
            background-color: #3498DB;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.2em;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .button-next:hover {
            background-color: #2980B9;
        }
        .notification {
            margin-top: 20px;
            font-size: 1em;
            color: #E74C3C;
            font-weight: bold;
            display: none;
        }
        .phase-display {
            font-size: 1.2em;
            color: #444;
            margin-bottom: 10px;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="timer-global" id="timer">--:--</div>
        <div class="exam-info" id="title">Timer ECOS</div>
        <div class="phase-display" id="phase">En attente</div>
        <div class="student-info">Étudiant: Jean Dupont, ID: 12345</div>

        <div class="progress-bar-container">
            <div class="progress-bar" id="progress-bar"></div>
        </div>

        <div class="question-section">
            <div class="question-number" id="question-number">Question 1 / 20</div>
            <div class="timer-question" id="timer-question">Temps restant pour cette question: 00:30</div>
            <button class="button-next" id="button-next" onclick="nextQuestion()">Question Suivante</button>
        </div>

        <div class="notification" id="notification">5 minutes restantes</div>
    </div>

    <!-- Audio elements -->
    <audio id="audio-prepare" src="./audio/prepare.mp3"></audio>
    <audio id="audio-work" src="./audio/work.mp3"></audio>
    <audio id="audio-rest" src="./audio/rest.mp3"></audio>
    <audio id="audio-done" src="./audio/done.mp3"></audio>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Variables globales pour l'examen
        let currentQuestion = 1;
        let totalQuestions = 20;
        let questionTimeRemaining = 30;
        let questionInterval = null;
        let answers = {};
        let examStarted = false;

        // Éléments existants du timer ECOS
        const socket = io();
        const titleEl = document.getElementById('title');
        const timerEl = document.getElementById('timer');
        const phaseEl = document.getElementById('phase');
        let interval = null;

        // Nouveaux éléments pour l'examen
        const questionNumberEl = document.getElementById('question-number');
        const timerQuestionEl = document.getElementById('timer-question');
        const buttonNextEl = document.getElementById('button-next');
        const notificationEl = document.getElementById('notification');
        const progressBarEl = document.getElementById('progress-bar');

        function playSound(name) {
            const audio = document.getElementById(`audio-${name}`);
            if (audio) audio.play();
        }

        function formatTime(seconds) {
            const m = Math.floor(seconds / 60);
            const s = seconds % 60;
            return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }

        function formatTimeHMS(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }

        // Fonctions du timer ECOS original
        function startSequence(config) {
            titleEl.textContent = config.title;
            let cycle = 1;
            runPhase('prepare', config.prepare, () => {
                runWorkCycle(cycle, config);
            });
        }

        function runWorkCycle(cycle, config) {
            if (cycle > config.cycles) {
                phaseEl.textContent = 'Terminé';
                timerEl.textContent = '--:--';
                playSound('done');
                return;
            }
            runPhase('work', config.work, () => {
                runPhase('rest', config.rest, () => {
                    runWorkCycle(cycle + 1, config);
                });
            });
        }

        function runPhase(type, duration, next) {
            phaseEl.textContent = phaseLabel(type);
            playSound(type);
            let sec = duration;
            clearInterval(interval);
            interval = setInterval(() => {
                let m = Math.floor(sec / 60).toString().padStart(2, '0');
                let s = (sec % 60).toString().padStart(2, '0');
                timerEl.textContent = `${m}:${s}`;
                if (--sec < 0) {
                    clearInterval(interval);
                    next();
                }
            }, 1000);
        }

        function phaseLabel(type) {
            switch(type) {
                case 'prepare': return 'Préparation';
                case 'work': return 'Travail';
                case 'rest': return 'Repos';
                default: return '';
            }
        }

        // Nouvelles fonctions pour l'examen
        function updateQuestionDisplay() {
            questionNumberEl.textContent = `Question ${currentQuestion} / ${totalQuestions}`;
            timerQuestionEl.textContent = `Temps restant pour cette question: ${formatTime(questionTimeRemaining)}`;
            
            // Mise à jour de la barre de progression
            const progress = ((currentQuestion - 1) / totalQuestions) * 100;
            progressBarEl.style.width = `${progress}%`;
        }

        function nextQuestion() {
            // Sauvegarder la réponse actuelle si elle existe
            const currentAnswer = getCurrentAnswer();
            if (currentAnswer) {
                answers[currentQuestion] = currentAnswer;
                console.log(`Réponse sauvegardée pour la question ${currentQuestion}:`, currentAnswer);
            }

            // Passer à la question suivante
            if (currentQuestion < totalQuestions) {
                currentQuestion++;
                questionTimeRemaining = 30; // Reset à 30 secondes
                updateQuestionDisplay();
                resetQuestionInterface();
                playSound('work'); // Son pour nouvelle question
            } else {
                endExam();
            }
        }

        function getCurrentAnswer() {
            // Simulation d'une réponse - dans une vraie implémentation,
            // cela récupérerait la réponse cochée
            const radios = document.querySelectorAll('input[name="answer"]:checked');
            return radios.length > 0 ? radios[0].value : null;
        }

        function resetQuestionInterface() {
            // Réinitialiser l'interface de la question
            const radios = document.querySelectorAll('input[name="answer"]');
            radios.forEach(radio => radio.checked = false);
        }

        function endExam() {
            clearInterval(questionInterval);
            timerQuestionEl.textContent = "Examen terminé";
            buttonNextEl.style.display = 'none';
            notificationEl.textContent = "Examen terminé - Réponses enregistrées";
            notificationEl.style.display = 'block';
            playSound('done');
            console.log("Réponses finales:", answers);
        }

        function startQuestionTimer() {
            clearInterval(questionInterval);
            questionInterval = setInterval(() => {
                questionTimeRemaining--;
                updateQuestionDisplay();
                
                if (questionTimeRemaining <= 0) {
                    // Temps écoulé pour cette question, passer à la suivante
                    nextQuestion();
                }
            }, 1000);
        }

        // Gestionnaires d'événements Socket.IO
        socket.on('start', data => {
            clearInterval(interval);
            clearInterval(questionInterval);
            examStarted = true;
            
            // Démarrer le timer ECOS
            startSequence(data);
            
            // Démarrer le timer des questions
            currentQuestion = 1;
            questionTimeRemaining = 30;
            updateQuestionDisplay();
            startQuestionTimer();
        });

        socket.on('reset', () => {
            clearInterval(interval);
            clearInterval(questionInterval);
            examStarted = false;
            
            phaseEl.textContent = 'Réinitialisé';
            timerEl.textContent = '--:--';
            
            // Reset de l'examen
            currentQuestion = 1;
            questionTimeRemaining = 30;
            answers = {};
            updateQuestionDisplay();
            buttonNextEl.style.display = 'inline-block';
            notificationEl.style.display = 'none';
            progressBarEl.style.width = '0%';
        });

        // Initialisation
        updateQuestionDisplay();
    </script>
</body>
</html>
