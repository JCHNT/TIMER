<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Timer Examen Universitaire</title>
    <style>
        body {
            font-family: sans-serif;
            text-align: center;
            background-color: #F2F2F2;
            margin: 0;
            padding: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .dashboard-container {
            background-color: #FFFFFF;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0px 10px 30px rgba(0, 0, 0, 0.1);
            width: 900px;
            max-width: 95%;
        }
        .timer-global {
            font-size: 4em;
            color: #2C3E50;
            margin-bottom: 20px;
            font-weight: bold;
        }
        .exam-info {
            font-size: 1.5em;
            color: #34495E;
            margin-bottom: 10px;
        }
        .student-info {
            font-size: 1.2em;
            color: #7F8C8D;
            margin-bottom: 30px;
            border-bottom: 1px solid #ECF0F1;
            padding-bottom: 20px;
        }
        .question-section {
            margin-top: 30px;
            margin-bottom: 30px;
            text-align: left;
        }
        .question-number {
            font-size: 1.8em;
            color: #2C3E50;
            margin-bottom: 20px;
            font-weight: bold;
            text-align: center;
        }
        .question-text {
            font-size: 1.3em;
            color: #2C3E50;
            margin-bottom: 20px;
            padding: 20px;
            background-color: #F8F9FA;
            border-radius: 8px;
            border-left: 4px solid #3498DB;
        }
        .options-container {
            margin: 20px 0;
        }
        .option-item {
            display: flex;
            align-items: center;
            margin: 15px 0;
            padding: 15px;
            background-color: #FFFFFF;
            border: 2px solid #ECF0F1;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .option-item:hover {
            border-color: #3498DB;
            background-color: #F8F9FA;
        }
        .option-item.selected {
            border-color: #3498DB;
            background-color: #E3F2FD;
        }
        .option-item input[type="radio"] {
            margin-right: 15px;
            transform: scale(1.2);
        }
        .option-text {
            font-size: 1.1em;
            color: #2C3E50;
        }
        .progress-bar-container {
            width: 100%;
            background-color: #ECF0F1;
            border-radius: 5px;
            height: 10px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            width: 0%;
            background-color: #3498DB;
            border-radius: 5px;
            transition: width 0.3s ease;
        }
        .navigation-buttons {
            text-align: center;
            margin-top: 30px;
        }
        .button-next {
            background-color: #3498DB;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.2em;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin: 0 10px;
        }
        .button-next:hover {
            background-color: #2980B9;
        }
        .button-next:disabled {
            background-color: #BDC3C7;
            cursor: not-allowed;
        }
        .notification {
            margin-top: 20px;
            font-size: 1em;
            color: #E74C3C;
            font-weight: bold;
            display: none;
            padding: 10px;
            background-color: #FADBD8;
            border-radius: 5px;
        }
        .phase-display {
            font-size: 1.2em;
            color: #7F8C8D;
            margin-bottom: 10px;
        }
        .exam-ended {
            color: #E74C3C;
            font-size: 2em;
            font-weight: bold;
        }
        .waiting-state {
            color: #95A5A6;
            font-style: italic;
        }
        .loading {
            color: #3498DB;
            font-style: italic;
        }
        .no-questions {
            color: #E67E22;
            font-size: 1.2em;
            padding: 20px;
            background-color: #FEF9E7;
            border-radius: 8px;
            border: 1px solid #F4D03F;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="timer-global" id="timer">--:--:--</div>
        <div class="exam-info" id="title">En attente de configuration...</div>
        <div class="phase-display" id="phase">Pr√™t √† commencer</div>
        <div class="student-info">√âtudiant: Jean Dupont, ID: 12345</div>

        <div class="progress-bar-container">
            <div class="progress-bar" id="progress-bar"></div>
        </div>

        <div class="question-section">
            <div class="question-number" id="question-number">Question 1 / --</div>
            
            <div id="question-content">
                <div class="loading">Chargement des questions...</div>
            </div>
            
            <div class="navigation-buttons">
                <button class="button-next" id="button-next" onclick="nextQuestion()">Question Suivante</button>
            </div>
        </div>

        <div class="notification" id="notification"></div>
    </div>

    <!-- Audio elements -->
    <audio id="audio-prepare" src="./audio/prepare.mp3"></audio>
    <audio id="audio-work" src="./audio/work.mp3"></audio>
    <audio id="audio-rest" src="./audio/rest.mp3"></audio>
    <audio id="audio-done" src="./audio/done.mp3"></audio>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Variables globales pour l'examen
        let currentQuestion = 1;
        let totalQuestions = 20;
        let totalTimeRemaining = 0;
        let examStarted = false;
        let examEnded = false;
        let globalInterval = null;
        let answers = {};
        let questions = [];
        let currentQuestionData = null;

        // √âl√©ments DOM
        const socket = io("http://localhost:3000");
        const titleEl = document.getElementById('title');
        const timerEl = document.getElementById('timer');
        const phaseEl = document.getElementById('phase');
        const questionNumberEl = document.getElementById('question-number');
        const questionContentEl = document.getElementById('question-content');
        const buttonNextEl = document.getElementById('button-next');
        const notificationEl = document.getElementById('notification');
        const progressBarEl = document.getElementById('progress-bar');

        // Charger les questions au d√©marrage
        loadQuestions();

        function playSound(name) {
            const audio = document.getElementById(`audio-${name}`);
            if (audio) {
                audio.play().catch(err => console.log('Erreur audio:', err));
            }
        }

        function formatTime(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }

        function loadQuestions() {
            fetch('/questions')
                .then(res => res.json())
                .then(data => {
                    questions = data;
                    if (questions.length === 0) {
                        questionContentEl.innerHTML = `
                            <div class="no-questions">
                                ‚ö†Ô∏è Aucune question disponible.<br>
                                Veuillez demander √† l'administrateur de cr√©er des questions.
                            </div>
                        `;
                    } else {
                        displayCurrentQuestion();
                    }
                })
                .catch(err => {
                    console.error('Erreur lors du chargement des questions:', err);
                    questionContentEl.innerHTML = `
                        <div class="no-questions">
                            ‚ùå Erreur lors du chargement des questions.<br>
                            Veuillez v√©rifier la connexion au serveur.
                        </div>
                    `;
                });
        }

        function displayCurrentQuestion() {
            if (questions.length === 0) {
                return;
            }

            const questionIndex = (currentQuestion - 1) % questions.length;
            currentQuestionData = questions[questionIndex];

            if (!currentQuestionData) {
                questionContentEl.innerHTML = '<div class="loading">Question non trouv√©e...</div>';
                return;
            }

            const optionsHtml = currentQuestionData.options.map((option, index) => `
                <div class="option-item" onclick="selectOption(${index})">
                    <input type="radio" name="answer" value="${index}" id="option-${index}">
                    <label class="option-text" for="option-${index}">
                        ${String.fromCharCode(65 + index)}) ${option}
                    </label>
                </div>
            `).join('');

            questionContentEl.innerHTML = `
                <div class="question-text">
                    ${currentQuestionData.question}
                </div>
                <div class="options-container">
                    ${optionsHtml}
                </div>
            `;

            // Restaurer la r√©ponse pr√©c√©dente si elle existe
            const savedAnswer = answers[currentQuestion];
            if (savedAnswer !== undefined) {
                selectOption(savedAnswer, false);
            }
        }

        function selectOption(optionIndex, playSound = true) {
            // D√©cocher toutes les options
            document.querySelectorAll('.option-item').forEach(item => {
                item.classList.remove('selected');
            });
            document.querySelectorAll('input[name="answer"]').forEach(radio => {
                radio.checked = false;
            });

            // S√©lectionner l'option choisie
            const selectedOption = document.getElementById(`option-${optionIndex}`);
            const selectedItem = selectedOption.closest('.option-item');
            
            selectedOption.checked = true;
            selectedItem.classList.add('selected');

            // Sauvegarder la r√©ponse
            answers[currentQuestion] = optionIndex;
            
            if (playSound) {
                // Son de s√©lection (utiliser le son work)
                playSound('work');
            }
        }

        function updateDisplay() {
            // Mise √† jour du minuteur global
            timerEl.textContent = formatTime(totalTimeRemaining);
            
            // Mise √† jour du num√©ro de question
            const displayTotal = Math.min(totalQuestions, questions.length);
            questionNumberEl.textContent = `Question ${currentQuestion} / ${displayTotal}`;
            
            // Mise √† jour de la barre de progression
            const progress = ((currentQuestion - 1) / displayTotal) * 100;
            progressBarEl.style.width = `${progress}%`;
            
            // Notifications bas√©es sur le temps restant
            if (totalTimeRemaining <= 300 && totalTimeRemaining > 0) { // 5 minutes
                notificationEl.textContent = "‚ö†Ô∏è 5 minutes restantes !";
                notificationEl.style.display = 'block';
            } else if (totalTimeRemaining <= 600 && totalTimeRemaining > 300) { // 10 minutes
                notificationEl.textContent = "‚è∞ 10 minutes restantes";
                notificationEl.style.display = 'block';
            } else {
                notificationEl.style.display = 'none';
            }
        }

        function nextQuestion() {
            if (examEnded) return;
            
            // Sauvegarder la r√©ponse actuelle
            saveCurrentAnswer();

            // Passer √† la question suivante
            const maxQuestions = Math.min(totalQuestions, questions.length);
            if (currentQuestion < maxQuestions) {
                currentQuestion++;
                displayCurrentQuestion();
                updateDisplay();
                playSound('work'); // Son pour nouvelle question
            } else {
                endExam();
            }
        }

        function saveCurrentAnswer() {
            const selectedOption = document.querySelector('input[name="answer"]:checked');
            if (selectedOption) {
                const answerData = {
                    question_id: currentQuestion,
                    answer: parseInt(selectedOption.value),
                    question_text: currentQuestionData ? currentQuestionData.question : '',
                    selected_option: currentQuestionData ? currentQuestionData.options[parseInt(selectedOption.value)] : '',
                    is_correct: currentQuestionData ? (parseInt(selectedOption.value) === currentQuestionData.correct) : false
                };
                
                // Sauvegarder localement
                answers[currentQuestion] = answerData;
                
                // Sauvegarder sur le serveur
                fetch('/answers', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(answerData)
                }).catch(err => console.log('Erreur sauvegarde:', err));
            }
        }

        function endExam() {
            examEnded = true;
            clearInterval(globalInterval);
            
            // Sauvegarder la derni√®re r√©ponse
            saveCurrentAnswer();
            
            timerEl.textContent = "TERMIN√â";
            timerEl.className = "timer-global exam-ended";
            phaseEl.textContent = "Fin de la composition";
            buttonNextEl.style.display = 'none';
            notificationEl.textContent = "üéØ Examen termin√© - R√©ponses enregistr√©es";
            notificationEl.style.display = 'block';
            
            // Afficher un r√©sum√©
            const totalAnswered = Object.keys(answers).length;
            questionContentEl.innerHTML = `
                <div style="text-align: center; padding: 30px;">
                    <h2>üéØ Examen Termin√©</h2>
                    <p>Vous avez r√©pondu √† <strong>${totalAnswered}</strong> questions sur <strong>${Math.min(totalQuestions, questions.length)}</strong>.</p>
                    <p>Vos r√©ponses ont √©t√© enregistr√©es automatiquement.</p>
                </div>
            `;
            
            playSound('done');
            console.log("R√©ponses finales:", answers);
        }

        function startExam(config) {
            examStarted = true;
            examEnded = false;
            
            // Configuration de l'examen
            titleEl.textContent = config.title || "Examen Universitaire";
            totalQuestions = config.totalQuestions || 20;
            totalTimeRemaining = config.totalTimeSeconds || (config.totalTime * 60) || 5400;
            
            // R√©initialisation
            currentQuestion = 1;
            answers = {};
            
            // Recharger les questions
            loadQuestions();
            
            // Affichage initial
            phaseEl.textContent = "Examen en cours";
            buttonNextEl.style.display = 'inline-block';
            timerEl.className = "timer-global";
            updateDisplay();
            
            // Son de d√©but
            playSound('prepare');
            
            // D√©marrage du minuteur global
            clearInterval(globalInterval);
            globalInterval = setInterval(() => {
                totalTimeRemaining--;
                updateDisplay();
                
                if (totalTimeRemaining <= 0) {
                    endExam();
                }
            }, 1000);
        }

        function resetExam() {
            examStarted = false;
            examEnded = false;
            clearInterval(globalInterval);
            
            // R√©initialisation de l'affichage
            titleEl.textContent = "En attente de configuration...";
            phaseEl.textContent = "Pr√™t √† commencer";
            timerEl.textContent = "--:--:--";
            timerEl.className = "timer-global";
            
            // Reset de l'examen
            currentQuestion = 1;
            totalQuestions = 20;
            totalTimeRemaining = 0;
            answers = {};
            
            // Recharger les questions
            loadQuestions();
            
            updateDisplay();
            buttonNextEl.style.display = 'inline-block';
            notificationEl.style.display = 'none';
            progressBarEl.style.width = '0%';
        }

        // Gestionnaires d'√©v√©nements Socket.IO
        socket.on('start', data => {
            console.log('D√©marrage de l\'examen avec la configuration:', data);
            startExam(data);
        });

        socket.on('reset', () => {
            console.log('R√©initialisation de l\'examen');
            resetExam();
        });

        // Gestion de la fermeture de la page
        window.addEventListener('beforeunload', (e) => {
            if (examStarted && !examEnded) {
                // Sauvegarder la r√©ponse actuelle avant de quitter
                saveCurrentAnswer();
                e.preventDefault();
                e.returnValue = '√ätes-vous s√ªr de vouloir quitter l\'examen en cours ?';
            }
        });

        // Initialisation
        updateDisplay();
    </script>
</body>
</html>
