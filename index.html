<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Timer Examen Universitaire</title>
    <style>
        body {
            font-family: sans-serif;
            text-align: center;
            background-color: #F2F2F2;
            margin: 0;
            padding: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .dashboard-container {
            background-color: #FFFFFF;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0px 10px 30px rgba(0, 0, 0, 0.1);
            width: 800px;
            max-width: 90%;
        }
        .timer-global {
            font-size: 4em;
            color: #2C3E50;
            margin-bottom: 20px;
            font-weight: bold;
        }
        .exam-info {
            font-size: 1.5em;
            color: #34495E;
            margin-bottom: 10px;
        }
        .student-info {
            font-size: 1.2em;
            color: #7F8C8D;
            margin-bottom: 30px;
            border-bottom: 1px solid #ECF0F1;
            padding-bottom: 20px;
        }
        .question-section {
            margin-top: 30px;
            margin-bottom: 30px;
        }
        .question-number {
            font-size: 1.8em;
            color: #2C3E50;
            margin-bottom: 20px;
            font-weight: bold;
        }
        .progress-bar-container {
            width: 100%;
            background-color: #ECF0F1;
            border-radius: 5px;
            height: 10px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            width: 0%;
            background-color: #3498DB;
            border-radius: 5px;
            transition: width 0.3s ease;
        }
        .button-next {
            background-color: #3498DB;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.2em;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .button-next:hover {
            background-color: #2980B9;
        }
        .notification {
            margin-top: 20px;
            font-size: 1em;
            color: #E74C3C;
            font-weight: bold;
            display: none;
        }
        .phase-display {
            font-size: 1.2em;
            color: #7F8C8D;
            margin-bottom: 10px;
        }
        .exam-ended {
            color: #E74C3C;
            font-size: 2em;
            font-weight: bold;
        }
        .waiting-state {
            color: #95A5A6;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="timer-global" id="timer">--:--:--</div>
        <div class="exam-info" id="title">En attente de configuration...</div>
        <div class="phase-display" id="phase">Pr√™t √† commencer</div>
        <div class="student-info">√âtudiant: Jean Dupont, ID: 12345</div>

        <div class="progress-bar-container">
            <div class="progress-bar" id="progress-bar"></div>
        </div>

        <div class="question-section">
            <div class="question-number" id="question-number">Question 1 / --</div>
            <button class="button-next" id="button-next" onclick="nextQuestion()">Question Suivante</button>
        </div>

        <div class="notification" id="notification"></div>
    </div>

    <!-- Audio elements -->
    <audio id="audio-prepare" src="./audio/prepare.mp3"></audio>
    <audio id="audio-work" src="./audio/work.mp3"></audio>
    <audio id="audio-rest" src="./audio/rest.mp3"></audio>
    <audio id="audio-done" src="./audio/done.mp3"></audio>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Variables globales pour l'examen
        let currentQuestion = 1;
        let totalQuestions = 20;
        let totalTimeRemaining = 0;
        let examStarted = false;
        let examEnded = false;
        let globalInterval = null;
        let answers = {};

        // √âl√©ments DOM
        const socket = io();
        const titleEl = document.getElementById('title');
        const timerEl = document.getElementById('timer');
        const phaseEl = document.getElementById('phase');
        const questionNumberEl = document.getElementById('question-number');
        const buttonNextEl = document.getElementById('button-next');
        const notificationEl = document.getElementById('notification');
        const progressBarEl = document.getElementById('progress-bar');

        function playSound(name) {
            const audio = document.getElementById(`audio-${name}`);
            if (audio) {
                audio.play().catch(err => console.log('Erreur audio:', err));
            }
        }

        function formatTime(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }

        function updateDisplay() {
            // Mise √† jour du minuteur global
            timerEl.textContent = formatTime(totalTimeRemaining);
            
            // Mise √† jour du num√©ro de question
            questionNumberEl.textContent = `Question ${currentQuestion} / ${totalQuestions}`;
            
            // Mise √† jour de la barre de progression
            const progress = ((currentQuestion - 1) / totalQuestions) * 100;
            progressBarEl.style.width = `${progress}%`;
            
            // Notifications bas√©es sur le temps restant
            if (totalTimeRemaining <= 300 && totalTimeRemaining > 0) { // 5 minutes
                notificationEl.textContent = "‚ö†Ô∏è 5 minutes restantes !";
                notificationEl.style.display = 'block';
            } else if (totalTimeRemaining <= 600 && totalTimeRemaining > 300) { // 10 minutes
                notificationEl.textContent = "‚è∞ 10 minutes restantes";
                notificationEl.style.display = 'block';
            } else {
                notificationEl.style.display = 'none';
            }
        }

        function nextQuestion() {
            if (examEnded) return;
            
            // Sauvegarder la r√©ponse actuelle si elle existe
            const currentAnswer = getCurrentAnswer();
            if (currentAnswer) {
                answers[currentQuestion] = currentAnswer;
                console.log(`R√©ponse sauvegard√©e pour la question ${currentQuestion}:`, currentAnswer);
            }

            // Passer √† la question suivante
            if (currentQuestion < totalQuestions) {
                currentQuestion++;
                updateDisplay();
                resetQuestionInterface();
                playSound('work'); // Son pour nouvelle question
            } else {
                endExam();
            }
        }

        function getCurrentAnswer() {
            // Simulation d'une r√©ponse - dans une vraie impl√©mentation,
            // cela r√©cup√©rerait la r√©ponse coch√©e
            const radios = document.querySelectorAll('input[name="answer"]:checked');
            return radios.length > 0 ? radios[0].value : null;
        }

        function resetQuestionInterface() {
            // R√©initialiser l'interface de la question
            const radios = document.querySelectorAll('input[name="answer"]');
            radios.forEach(radio => radio.checked = false);
        }

        function endExam() {
            examEnded = true;
            clearInterval(globalInterval);
            
            timerEl.textContent = "TERMIN√â";
            timerEl.className = "timer-global exam-ended";
            phaseEl.textContent = "Fin de la composition";
            buttonNextEl.style.display = 'none';
            notificationEl.textContent = "üéØ Examen termin√© - R√©ponses enregistr√©es";
            notificationEl.style.display = 'block';
            
            playSound('done');
            console.log("R√©ponses finales:", answers);
        }

        function startExam(config) {
            examStarted = true;
            examEnded = false;
            
            // Configuration de l'examen
            titleEl.textContent = config.title || "Examen Universitaire";
            totalQuestions = config.totalQuestions || 20;
            totalTimeRemaining = config.totalTimeSeconds || (config.totalTime * 60) || 5400; // Par d√©faut 90 minutes
            
            // R√©initialisation
            currentQuestion = 1;
            answers = {};
            
            // Affichage initial
            phaseEl.textContent = "Examen en cours";
            buttonNextEl.style.display = 'inline-block';
            timerEl.className = "timer-global";
            updateDisplay();
            
            // Son de d√©but
            playSound('prepare');
            
            // D√©marrage du minuteur global
            clearInterval(globalInterval);
            globalInterval = setInterval(() => {
                totalTimeRemaining--;
                updateDisplay();
                
                if (totalTimeRemaining <= 0) {
                    endExam();
                }
            }, 1000);
        }

        function resetExam() {
            examStarted = false;
            examEnded = false;
            clearInterval(globalInterval);
            
            // R√©initialisation de l'affichage
            titleEl.textContent = "En attente de configuration...";
            phaseEl.textContent = "Pr√™t √† commencer";
            timerEl.textContent = "--:--:--";
            timerEl.className = "timer-global";
            
            // Reset de l'examen
            currentQuestion = 1;
            totalQuestions = 20;
            totalTimeRemaining = 0;
            answers = {};
            
            updateDisplay();
            buttonNextEl.style.display = 'inline-block';
            notificationEl.style.display = 'none';
            progressBarEl.style.width = '0%';
        }

        // Gestionnaires d'√©v√©nements Socket.IO
        socket.on('start', data => {
            console.log('D√©marrage de l\'examen avec la configuration:', data);
            startExam(data);
        });

        socket.on('reset', () => {
            console.log('R√©initialisation de l\'examen');
            resetExam();
        });

        // Gestion de la fermeture de la page (pr√©vention de la perte de donn√©es)
        window.addEventListener('beforeunload', (e) => {
            if (examStarted && !examEnded) {
                e.preventDefault();
                e.returnValue = '√ätes-vous s√ªr de vouloir quitter l\'examen en cours ?';
            }
        });

        // Initialisation
        updateDisplay();
    </script>
</body>
</html>

