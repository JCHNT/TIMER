<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TIMER SYNCHRONISE</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            text-align: center; 
            font-size: 2em; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0; 
            padding: 40px; 
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            min-width: 400px;
        }
        
        .title { 
            font-size: 1.5em; 
            margin-bottom: 30px; 
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        #phase { 
            font-size: 2.5em; 
            color: #fff; 
            margin-bottom: 30px; 
            font-weight: 300;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .timer { 
            font-size: 4em; 
            font-weight: bold; 
            margin-bottom: 20px; 
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            font-family: 'Courier New', monospace;
        }
        
        .progress-info {
            font-size: 0.8em;
            opacity: 0.8;
            margin-bottom: 20px;
        }
        
        .description {
            font-size: 0.6em;
            opacity: 0.7;
            margin-bottom: 20px;
            font-style: italic;
        }
        
        .controls {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 30px;
        }
        
        .control-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 0.5em;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        
        .control-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        @media (max-width: 768px) {
            body { font-size: 1.5em; padding: 20px; }
            .timer { font-size: 3em; }
            #phase { font-size: 2em; }
            .container { min-width: auto; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="title" class="title">TIMER ECOS</div>
        <div id="phase">En attente...</div>
        <div id="description" class="description"></div>
        <div id="timer" class="timer">---</div>
        <div id="progress" class="progress-info"></div>
        
        <div class="controls">
            <a href="/admin.html" class="control-btn">Administration</a>
            <button class="control-btn" onclick="resetTimer()">Réinitialiser</button>
        </div>
    </div>
    
    <audio id="audio_prepare" src="/audio/prepare.mp3"></audio>
    <audio id="audio_work" src="/audio/work.mp3"></audio>
    <audio id="audio_rest" src="/audio/rest.mp3"></audio>
    <audio id="audio_done" src="/audio/done.mp3"></audio>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();

        const titleEl = document.getElementById('title');
        const timerEl = document.getElementById('timer');
        const phaseEl = document.getElementById('phase');
        const descriptionEl = document.getElementById('description');
        const progressEl = document.getElementById('progress');

        const audio = {
            prepare: document.getElementById('audio_prepare'),
            work: document.getElementById('audio_work'),
            rest: document.getElementById('audio_rest'),
            done: document.getElementById('audio_done')
        };

        let interval;
        let currentConfig = {};
        let currentSet = 1;
        let currentCycle = 1;

        function playSound(name) {
            if (audio[name]) {
                audio[name].play().catch(e => console.log('Audio play failed:', e));
            }
        }

        function startSequence(config) {
            currentConfig = config;
            titleEl.textContent = config.title || 'TIMER ECOS';
            currentSet = 1;
            currentCycle = 1;
            
            // Commencer par la préparation
            runPhase('prepare', config.prepare, () => {
                runSet(currentSet, config);
            });
        }

        function runSet(setNumber, config) {
            if (setNumber > config.sets) {
                // Tous les sets sont terminés, cool down
                if (config.coolDown > 0) {
                    runPhase('coolDown', config.coolDown, () => {
                        phaseEl.textContent = 'Terminé';
                        timerEl.textContent = '---';
                        descriptionEl.textContent = '';
                        progressEl.textContent = '';
                        playSound('done');
                    });
                } else {
                    phaseEl.textContent = 'Terminé';
                    timerEl.textContent = '---';
                    descriptionEl.textContent = '';
                    progressEl.textContent = '';
                    playSound('done');
                }
                return;
            }
            
            currentCycle = 1;
            runWorkCycle(currentCycle, setNumber, config);
        }

        function runWorkCycle(cycle, setNumber, config) {
            if (cycle > config.cycles) {
                // Cycles terminés pour ce set
                if (setNumber < config.sets && config.restBetweenSets > 0) {
                    // Repos entre les sets
                    runPhase('restBetweenSets', config.restBetweenSets, () => {
                        currentSet++;
                        runSet(currentSet, config);
                    });
                } else {
                    currentSet++;
                    runSet(currentSet, config);
                }
                return;
            }
            
            // Phase de travail
            runPhase('work', config.work, () => {
                // Phase de repos
                runPhase('rest', config.rest, () => {
                    currentCycle++;
                    runWorkCycle(currentCycle, setNumber, config);
                });
            });
        }

        function runPhase(type, duration, next) {
            const phaseInfo = getPhaseInfo(type);
            phaseEl.textContent = phaseInfo.label;
            descriptionEl.textContent = phaseInfo.description;
            
            // Afficher les informations de progression
            updateProgress();
            
            playSound(type);
            clearInterval(interval);
            
            interval = setInterval(() => {
                let m = Math.floor(duration / 60).toString().padStart(2, '0');
                let s = (duration % 60).toString().padStart(2, '0');
                timerEl.textContent = `${m}:${s}`;
                
                if (--duration < 0) {
                    clearInterval(interval);
                    next();
                }
            }, 1000);
        }

        function getPhaseInfo(type) {
            switch (type) {
                case 'prepare':
                    return { label: 'Préparation', description: 'Préparez-vous...' };
                case 'work':
                    return { 
                        label: 'Travail', 
                        description: currentConfig.workDescription || 'Phase de travail'
                    };
                case 'rest':
                    return { 
                        label: 'Repos', 
                        description: currentConfig.restDescription || 'Phase de repos'
                    };
                case 'restBetweenSets':
                    return { label: 'Repos entre sets', description: 'Repos entre les séries' };
                case 'coolDown':
                    return { label: 'Récupération', description: 'Phase de récupération' };
                default:
                    return { label: '', description: '' };
            }
        }

        function updateProgress() {
            if (currentConfig.sets && currentConfig.cycles) {
                progressEl.textContent = `Set ${currentSet}/${currentConfig.sets} - Cycle ${currentCycle}/${currentConfig.cycles}`;
            }
        }

        function resetTimer() {
            clearInterval(interval);
            phaseEl.textContent = 'Réinitialisé';
            timerEl.textContent = '---';
            descriptionEl.textContent = '';
            progressEl.textContent = '';
            socket.emit('reset');
        }

        socket.on('start', data => {
            clearInterval(interval);
            startSequence(data);
        });

        socket.on('reset', () => {
            resetTimer();
        });

        socket.on('connect', () => {
            console.log('Connecté au serveur');
        });

        socket.on('disconnect', () => {
            console.log('Déconnecté du serveur');
        });
    </script>
</body>
</html>

